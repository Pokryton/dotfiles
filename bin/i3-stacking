#!/usr/bin/env python3
#
# Splits the current window into a stacked layout, runs a command, then restores the original layout.
# Handy for opening images and videos "inside" a terminal.

from i3ipc import Connection
import subprocess
import sys

if len(sys.argv) < 2:
    print("Usage: %s <command...>" % sys.argv[0])
    sys.exit(1)

i3 = Connection()
orig = i3.get_tree().find_focused()

# If the layout was already tabbed or stacked, don't do anything
layout = orig.parent.layout
if layout == "splith":
    orig.command("split v")
    orig.command("layout stacking")
elif layout == "splitv":
    orig.command("split h")
    orig.command("layout stacking")

try:
    # Run the given command
    code = subprocess.run(sys.argv[1:]).returncode

finally:
    # Unsplit the container if it was previously split to restore the old layout
    if layout == "splith":
        orig.command("layout default")
        orig.command("move left")
    elif layout == "splitv":
        orig.command("layout default")
        orig.command("move up")

# Pass along the command's return code
sys.exit(code)
